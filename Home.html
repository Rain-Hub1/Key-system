<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File System Portal</title>
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <style>
        :root { --bg: #121212; --surface: #1e1e1e; --primary: #bb86fc; --secondary: #03dac6; --text: #e0e0e0; --text-muted: #888; --error: #cf6679; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; }
        .page { display: none; min-height: 100vh; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .page.active { display: flex; flex-direction: column; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .container { background-color: var(--surface); border-radius: 8px; padding: 30px; width: 90%; max-width: 600px; box-shadow: 0 8px 30px rgba(0,0,0,0.5); margin-top: 20px; }
        nav { background: var(--surface); padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3); width: 100%; box-sizing: border-box; }
        nav a { color: var(--secondary); text-decoration: none; margin: 0 15px; font-weight: bold; }
        h1, h2 { color: var(--primary); text-align: center; }
        p { color: var(--text-muted); text-align: center; }
        .form-group { margin-bottom: 20px; }
        .input-field, textarea { width: 100%; padding: 12px; background-color: #333; border: 1px solid #555; border-radius: 4px; color: var(--text); font-size: 1rem; box-sizing: border-box; font-family: inherit; }
        textarea { min-height: 200px; font-family: 'Courier New', monospace; }
        .btn { background-color: var(--primary); color: var(--bg); border: none; border-radius: 4px; padding: 12px 20px; font-size: 1rem; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: filter 0.2s; }
        .btn:hover { filter: brightness(1.2); }
        .btn-danger { background-color: var(--error); }
        .error-msg { color: var(--error); text-align: center; min-height: 20px; font-weight: bold; }
        .file-item { background: #2a2a2a; padding: 15px; border-radius: 4px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .file-item-actions a { margin-left: 10px; }
        pre { background: #111; padding: 15px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; color: var(--secondary); }
    </style>
</head>
<body>

    <nav id="navbar">
        <a href="#/Home">Home</a>
        <a href="#/My-Files" id="nav-my-files" style="display:none;">Meus Arquivos</a>
        <a href="#/Login" id="nav-login">Login</a>
        <a href="#" id="nav-logout" style="display:none;">Logout</a>
    </nav>

    <!-- PÁGINAS (mesma estrutura de antes) -->
    <div id="Home" class="page"><div class="container"><h1>Bem-vindo</h1><p>Faça login para gerenciar seus arquivos de configuração.</p></div></div>
    <div id="Login" class="page"><div class="container">... (código do login omitido por brevidade, é o mesmo da resposta anterior) ...</div></div>
    <div id="Register" class="page"><div class="container">... (código do registro omitido por brevidade) ...</div></div>

    <!-- PÁGINA: My-Files -->
    <div id="My-Files" class="page">
        <div class="container">
            <h2>Meus Arquivos</h2>
            <div id="my-files-list"></div>
            <button id="create-new-file-btn" class="btn" style="margin-top: 20px;">Criar Novo Arquivo</button>
        </div>
    </div>

    <!-- PÁGINA: Edit-File -->
    <div id="Edit-File" class="page">
        <div class="container" id="edit-file-container">
            <!-- Conteúdo dinâmico -->
        </div>
    </div>

    <!-- PÁGINA: File (Visualização) -->
    <div id="File" class="page">
        <div class="container" id="view-file-container">
            <!-- Conteúdo dinâmico -->
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO E ROTEADOR (mesmo da resposta anterior) ---
        const BACK4APP_APP_ID = 'SUA_APPLICATION_ID';
        const BACK4APP_JS_KEY = 'SUA_JAVASCRIPT_KEY';
        Parse.initialize(BACK4APP_APP_ID, BACK4APP_JS_KEY);
        Parse.serverURL = 'https://parseapi.back4app.com/';
        
        // ... (código do roteador, login, registro e logout omitido por brevidade, use o da resposta anterior) ...

        // --- LÓGICA DAS PÁGINAS DE ARQUIVO ---

        // Página My-Files
        const handleMyFilesPage = async () => {
            const currentUser = Parse.User.current();
            if (!currentUser) { window.location.hash = '#/Login'; return; }

            const listContainer = document.getElementById('my-files-list');
            listContainer.innerHTML = '<p>Carregando arquivos...</p>';

            const UserFile = Parse.Object.extend("UserFile");
            const query = new Parse.Query(UserFile);
            query.equalTo("owner", currentUser);
            query.descending("updatedAt");
            const files = await query.find();

            if (files.length === 0) {
                listContainer.innerHTML = '<p>Você ainda não criou nenhum arquivo.</p>';
                return;
            }

            listContainer.innerHTML = '';
            files.forEach(file => {
                const fileId = file.id;
                const fileName = file.get('fileName') || 'Arquivo sem nome';
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <span>${fileName}</span>
                    <div class="file-item-actions">
                        <a href="#/File?id=${fileId}" class="link">Ver</a>
                        <a href="#/Edit-File?id=${fileId}" class="link">Editar</a>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        };
        
        document.getElementById('create-new-file-btn').addEventListener('click', () => {
            window.location.hash = '#/Edit-File'; // Vai para a página de edição sem ID
        });

        // Página Edit-File (Criação e Edição)
        const handleEditFilePage = async () => {
            const currentUser = Parse.User.current();
            if (!currentUser) { window.location.hash = '#/Login'; return; }

            const params = new URLSearchParams(window.location.hash.split('?')[1]);
            const fileId = params.get('id');
            const container = document.getElementById('edit-file-container');
            
            let file = null;
            let fileName = '';
            let fileContent = '{\n  "setting": "value",\n  "enabled": true\n}'; // Conteúdo padrão para novos arquivos

            if (fileId) { // Modo Edição
                container.innerHTML = '<h2>Carregando Editor...</h2>';
                const UserFile = Parse.Object.extend("UserFile");
                const query = new Parse.Query(UserFile);
                try {
                    file = await query.get(fileId);
                    // VERIFICAÇÃO DE SEGURANÇA
                    if (file.get('owner').id !== currentUser.id) {
                        container.innerHTML = '<h2>Acesso Negado</h2><p>Você não tem permissão para editar este arquivo.</p>';
                        return;
                    }
                    fileName = file.get('fileName');
                    fileContent = JSON.stringify(file.get('fileContent'), null, 2); // Formata o JSON
                } catch (error) {
                    container.innerHTML = `<h2>Erro</h2><p>Arquivo não encontrado.</p>`;
                    return;
                }
            }

            // Renderiza o formulário
            container.innerHTML = `
                <h2>${fileId ? 'Editar Arquivo' : 'Criar Novo Arquivo'}</h2>
                <div class="form-group">
                    <label for="file-name">Nome do Arquivo</label>
                    <input type="text" id="file-name" class="input-field" value="${fileName}">
                </div>
                <div class="form-group">
                    <label for="file-content">Conteúdo (JSON)</label>
                    <textarea id="file-content">${fileContent}</textarea>
                </div>
                <div id="edit-error" class="error-msg"></div>
                <button id="save-file-btn" class="btn">Salvar</button>
                ${fileId ? '<button id="delete-file-btn" class="btn btn-danger" style="margin-top:10px;">Deletar Arquivo</button>' : ''}
            `;

            // Event Listener para Salvar
            document.getElementById('save-file-btn').addEventListener('click', async () => {
                const newName = document.getElementById('file-name').value;
                const newContentStr = document.getElementById('file-content').value;
                let newContent;

                try {
                    newContent = JSON.parse(newContentStr);
                } catch (e) {
                    document.getElementById('edit-error').textContent = 'Erro: O conteúdo não é um JSON válido.';
                    return;
                }

                if (!file) { // Criando novo
                    file = new (Parse.Object.extend("UserFile"))();
                    file.set("owner", currentUser);
                }
                
                file.set("fileName", newName);
                file.set("fileContent", newContent);

                try {
                    await file.save();
                    alert('Arquivo salvo com sucesso!');
                    window.location.hash = '#/My-Files';
                } catch (error) {
                    document.getElementById('edit-error').textContent = `Erro ao salvar: ${error.message}`;
                }
            });

            // Event Listener para Deletar
            if (fileId) {
                document.getElementById('delete-file-btn').addEventListener('click', async () => {
                    if (confirm('Tem certeza que deseja deletar este arquivo permanentemente?')) {
                        try {
                            await file.destroy();
                            alert('Arquivo deletado com sucesso.');
                            window.location.hash = '#/My-Files';
                        } catch (error) {
                            document.getElementById('edit-error').textContent = `Erro ao deletar: ${error.message}`;
                        }
                    }
                });
            }
        };

        // Página File (Visualização)
        const handleViewFilePage = async () => {
            const container = document.getElementById('view-file-container');
            container.innerHTML = '<h2>Carregando Arquivo...</h2>';
            
            const params = new URLSearchParams(window.location.hash.split('?')[1]);
            const fileId = params.get('id');

            if (!fileId) {
                container.innerHTML = '<h2>Erro</h2><p>Nenhum ID de arquivo fornecido.</p>';
                return;
            }

            const UserFile = Parse.Object.extend("UserFile");
            const query = new Parse.Query(UserFile);
            try {
                const file = await query.get(fileId);
                const fileName = file.get('fileName');
                const fileContent = JSON.stringify(file.get('fileContent'), null, 2);
                
                container.innerHTML = `
                    <h2>${fileName}</h2>
                    <p>ID do Arquivo: ${file.id}</p>
                    <pre><code>${fileContent}</code></pre>
                `;
            } catch (error) {
                container.innerHTML = '<h2>Erro</h2><p>Arquivo não encontrado ou acesso negado.</p>';
            }
        };
        
        // Adiciona as novas rotas ao roteador
        const originalRouter = router;
        router = () => {
            originalRouter(); // Chama a função de roteamento base
            const hash = window.location.hash.split('?')[0];
            if (hash === '#/My-Files') handleMyFilesPage();
            if (hash === '#/Edit-File') handleEditFilePage();
            if (hash === '#/File') handleViewFilePage();
        };
        
        window.addEventListener('hashchange', router);
        window.addEventListener('load', router);
    </script>
</body>
</html>
